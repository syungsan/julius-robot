<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#000000">
    <meta name="name" content="PyScript/Panel KMeans Demo">

    <title>Pyscript/Panel KMeans Demo</title>
    <link rel="icon" type="image/x-icon" href="./favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/@holoviz/panel@0.13.1/dist/css/widgets.css" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/@holoviz/panel@0.13.1/dist/css/markdown.css" type="text/css" />

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-2.4.2.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@holoviz/panel@0.13.1/dist/panel.min.js"></script>
    <script type="text/javascript">
      Bokeh.set_log_level("info");
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/@holoviz/panel@0.13.1/dist/bundled/bootstraptemplate/bootstrap.css">
    <link rel="stylesheet" href="https://unpkg.com/@holoviz/panel@0.13.1/dist/bundled/defaulttheme/default.css">

    <style>
      #sidebar {
	  width: 350px;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

  </head>

  <py-env>
    - altair
    - numpy
    - pandas
    - hvplot
    - scikit-learn
    - panel==0.13.1
      parquet
  </py-env>

  <body>
    <div class="container-fluid d-flex flex-column vh-100 overflow-hidden" id="container">
      <nav class="navbar navbar-expand-md navbar-dark sticky-top shadow" id="header" style="background-color: #000000;">
	<button type="button" class="navbar-toggle collapsed" id="sidebarCollapse">
	  <span class="navbar-toggler-icon"></span>
	</button>
	<div class="app-header">
	  <a class="navbar-brand app-logo" href="/">
	    <img src="./logo.png" class="app-logo">
	  </a>
	  <a class="title" href="" style="color: #f0ab3c;">Panel KMeans Clustering Demo</a>
	</div>
      </nav>

      <div class="row overflow-hidden" id="content">
	<div class="sidenav" id="sidebar">
	  <ul class="nav flex-column">
            <div class="bk-root" id="x-widget"></div>
            <div class="bk-root" id="y-widget"></div>
            <div class="bk-root" id="n-widget"></div>
	  </ul>
	</div>
	<div class="col mh-100 float-left" id="main">
	  <div class="bk-root" id="intro"></div>
	  <div class="bk-root" id="cluster-plot"></div>
	  <div class="bk-root" id="table"></div>
	</div>
      </div>
    </div>

    <py-script>
# was ok with https://pyscript.net/2022.06.1/pyscript.js 
# you can try last official release: https://pyscript.net/latest/pyscript.js and css
# or current unstable master: https://pyscript.net/unstable/pyscript.js  and css
import pandas as pd
import panel as pn
import hvplot.pandas
import holoviews as hv
from io import StringIO

from sklearn.cluster import KMeans
from pyodide.http import open_url

pn.config.sizing_mode = 'stretch_width'

SITE = "Man-Group"
TITLE = "Options Analytics"
LOGO = "https://pydata.org/london2022/wp-content/uploads/2022/02/PyData_logo.png"

SOURCE_DATA = "https://github.com/man-group/pydata2022/raw/main/option_chain_data.parquet"
LOCAL_DATA = "option_chain_data.parquet"

COLUMNS = ["type", "strike", "inTheMoney", "impliedVolatility", "lastPrice", "lastTradeDate", "volume", "openInterest", "bid", "ask", "spread", "change", "percentChange", "contractSymbol", ]
HOVER_COLS = ["strike", "impliedVolatility", "lastPrice", "volume", "openInterest", "bid", "ask", "spread", "contractSymbol",]

def extract():
    try:
        return pd.read_parquet(LOCAL_DATA)
    except FileNotFoundError:
        data = pd.read_parquet(SOURCE_DATA)
        data.to_parquet(LOCAL_DATA)
        return data


source_data = extract()
def transform(data: pd.DataFrame) -> pd.DataFrame:
    data["date"] = data["date"].astype("datetime64[ns]")
    data["inTheMoney"] = data["inTheMoney"].astype("bool")

    data["spread"] = data["ask"] - data["bid"]
    return data[COLUMNS]


data = transform(source_data)

def get_plots(data: pd.DataFrame):
    call_data = data[data["type"] == "Call"]
    put_data = data[data["type"] == "Put"]
    plots = [
        call_data.hvplot(
            x="strike",
            y="impliedVolatility",
            responsive=True,
            min_height=300,
            ylabel="Implied Volatility",
            title="Call",
            hover_cols=HOVER_COLS,
        ),
        put_data.hvplot(
            x="strike",
            y="impliedVolatility",
            responsive=True,
            min_height=300,
            ylabel="Implied Volatility",
            title="Put",
            hover_cols=HOVER_COLS,
        ),
        call_data.hvplot(
            x="strike",
            y="openInterest",
            responsive=True,
            height=200,
            ylabel="Open Interest",
            hover_cols=HOVER_COLS,
        ),
        put_data.hvplot(
            x="strike",
            y="openInterest",
            responsive=True,
            height=200,
            ylabel="Open Interest",
            hover_cols=HOVER_COLS,
        ),
        call_data.hvplot(
            x="strike",
            y="spread",
            responsive=True,
            height=200,
            ylabel="Spread",
            hover_cols=HOVER_COLS,
        ),
        put_data.hvplot(
            x="strike",
            y="spread",
            responsive=True,
            height=200,
            ylabel="Spread",
            hover_cols=HOVER_COLS,
        ),
    ]
    layout = hv.Layout(plots).cols(2)
    return layout


plots = get_plots(data)

stock_selector = pn.widgets.Select(options=["Google"], name="Name", max_width=300)


def get_stringio(data: pd.DataFrame) -> StringIO:
    sio = StringIO()
    data.to_csv(sio)
    sio.seek(0)
    return sio

sio_to_download = get_stringio(data)

download_button = pn.widgets.FileDownload(
    sio_to_download,
    embed=True,
    filename="google.csv",
    sizing_mode="fixed",
    width=150,
    height=52,
    name="Download",
    label="google.csv"
)
plot_pane = pn.pane.HoloViews(plots, sizing_mode="stretch_both")
pivot_pane = pn.pane.Perspective(data, sizing_mode="stretch_both")
doc_pane = pn.pane.Markdown("""
# Option Chain Visualization

The *Option Analytics* tool was developed as a part of the PyData London 2022 chart visualization competition by **Man-Group**. 

The data is *option chain data*. See [Investopedia - Option Chain](https://www.investopedia.com/terms/o/optionchain.asp#:~:text=An%20options%20chain%2C%20also%20known,within%20a%20given%20maturity%20period).

I've used [Panel](https://panel.holoviz.org/index.html) as *data app framework* and [hvPlot](https://hvplot.holoviz.org/). These tools are superior for working in an out of a notebook. Especially for quant analysis.

Source: [man-group/pydata2022](https://github.com/man-group/pydata2022)
""", name="üéì Docs")

tab_layout = pn.Tabs(("üìà Plot", plot_pane), ("üõ†Ô∏è Pivot", pivot_pane), doc_pane, margin=10)

tool_layout = pn.Column(
    pn.Row(stock_selector, download_button, margin=(10,0,20,0)),
    tab_layout,
)
tool_layout.servable()

    </py-script>

    <script>
      $(document).ready(function () {
        $('#sidebarCollapse').on('click', function () {
        $('#sidebar').toggleClass('active')
        $(this).toggleClass('active')
        var interval = setInterval(function () { window.dispatchEvent(new Event('resize')); }, 10);
          setTimeout(function () { clearInterval(interval) }, 210)
        });
      });
    </script>
  </body>
</html>